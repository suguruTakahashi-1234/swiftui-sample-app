name: Auto Move PR to Review Column

on:
  pull_request:
    types: [opened]

jobs:
  move-card:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            const userName = "suguruTakahashi-1234";
            const projectName = "sample-project";
            const columnName = "👀 In Review (PR)";

            async function getProjectId() {
                const projects = await github.rest.projects.listForUser({
                    username: userName,
                    state: "open"  // activeなプロジェクトのみ取得
                });
                const project = projects.data.find(p => p.name === projectName);
                if (project) {
                    console.log(`Found project "${projectName}" with ID: ${project.id}`);
                    return project.id;
                } else {
                    throw new Error(`Project "${projectName}" not found`);
                }
            }

            async function getColumnId(projectId) {
                const columns = await github.rest.projects.listColumns({ project_id: projectId });
                const column = columns.data.find(col => col.name === columnName);
                if (column) {
                    console.log(`Found column "${columnName}" with ID: ${column.id}`);
                    return column.id;
                } else {
                    throw new Error(`Column "${columnName}" not found`);
                }
            }

            async function getCardId(issueId, projectId) {
                const cards = await github.rest.projects.listCards({ project_id: projectId });
                const card = cards.data.find(card => card.content_id === issueId);
                if (card) {
                    console.log(`Found card for PR #${issueId} with ID: ${card.id}`);
                    return card.id;
                } else {
                    throw new Error(`Card for PR #${issueId} not found`);
                }
            }

            async function run() {
                const projectId = await getProjectId();
                const columnId = await getColumnId(projectId);
                const cardId = await getCardId(github.context.payload.pull_request.id, projectId);
                await github.rest.projects.moveCard({
                    card_id: cardId,
                    column_id: columnId,
                    position: "top"
                });
                console.log(`Successfully moved card with ID: ${cardId} to column with ID: ${columnId}`);
            }

            run();
